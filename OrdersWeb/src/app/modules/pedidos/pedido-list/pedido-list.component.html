<div class="container mt-4">
  <!-- Header con navegación -->
  <div class="header">
    <div class="header-content">
      <div class="header-title">
        <h1>📋 Gestión de Pedidos</h1>
        <p>Administra tus pedidos de manera eficiente</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-primary me-2" (click)="irAFormulario()">
          ➕ Nuevo Pedido
        </button>
        <button class="btn btn-info me-2" (click)="irADashboard()">
          📊 Dashboard
        </button>
        <button class="btn btn-danger" (click)="logout()">
          🚪 Cerrar Sesión
        </button>
      </div>
    </div>
  </div>

  <!-- Alertas -->
  <div class="alert alert-success" *ngIf="success">
    <span>✓</span> <span>{{ success }}</span>
  </div>
  <div class="alert alert-danger" *ngIf="error">
    <span>⚠</span> <span>{{ error }}</span>
  </div>

  <!-- Filtros -->
  <div class="section">
    <h2 class="section-title">
      <span class="section-icon">🔎</span> Filtros de Búsqueda
    </h2>
    <form (ngSubmit)="aplicarFiltros()" class="form-grid">
      <div class="form-group">
        <label for="estado">Estado</label>
        <select id="estado" class="form-input" [(ngModel)]="filtroEstado" name="estado">
          <option value="">Todos</option>
          <option *ngFor="let estado of estadosPedido" [value]="estado">{{ estado }}</option>
        </select>
      </div>
      <div class="form-group">
        <label for="cliente">Cliente</label>
        <input type="text" id="cliente" class="form-input" [(ngModel)]="filtroCliente" name="cliente" placeholder="ID Cliente" />
      </div>
      <div class="form-group">
        <label for="fechaInicio">Fecha desde</label>
        <input type="date" id="fechaInicio" class="form-input" [(ngModel)]="filtroFechaInicio" name="fechaInicio" />
      </div>
      <div class="form-group">
        <label for="fechaFin">Fecha hasta</label>
        <input type="date" id="fechaFin" class="form-input" [(ngModel)]="filtroFechaFin" name="fechaFin" />
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary me-2">Aplicar</button>
        <button type="button" class="btn btn-secondary" (click)="limpiarFiltros()">Limpiar</button>
      </div>
    </form>
  </div>

  <!-- Tabla -->
  <div class="section" *ngIf="!loading && pedidos.length > 0; else noData">
    <h2 class="section-title">
      <span class="section-icon">📦</span> Lista de Pedidos
    </h2>

    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Cliente</th>
            <th>Ruta</th>
            <th>Fecha Entrega</th>
            <th>Estado</th>
            <th>Observaciones</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let pedido of pedidos">
            <td>{{ pedido.id }}</td>
            <!-- 🔹 Aquí se ajusta para usar IDs -->
            <td>{{ getClienteNombre(pedido.cliente_id) }}</td>
            <td>{{ getRutaNombre(pedido.ruta_id) }}</td>
            <td>{{ pedido.fecha_entrega | date:'short' }}</td>
            <td>
              <span [class]="getEstadoClass(pedido.estado_pedido)">
                {{ pedido.estado_pedido }}
              </span>
            </td>
            <td>{{ pedido.observaciones || '-' }}</td>
            <td class="text-center actions-col">
              <select
                class="form-input estado-select"
                [ngModel]="pedido.estado_pedido"
                (ngModelChange)="cambiarEstadoPedido(pedido.id, $event)"
              >
                <option *ngFor="let estado of estadosPedido" [ngValue]="estado">
                  {{ estado }}
                </option>
              </select>
              <button 
                class="btn btn-sm btn-outline-primary ms-2" 
                (click)="irAEditar(pedido.id)"
                title="Editar pedido"
              >
                📝 Editar
              </button>
              <button 
                class="btn btn-sm btn-danger ms-2" 
                (click)="eliminarPedido(pedido.id)"
                title="Eliminar"
              >
                🗑️ Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="pagination">
      <button class="btn btn-secondary" (click)="cambiarPagina(paginaActual - 1)" [disabled]="!tienePaginaAnterior">Anterior</button>
      <span>Página {{ paginaActual }} de {{ totalPaginas }}</span>
      <button class="btn btn-secondary" (click)="cambiarPagina(paginaActual + 1)" [disabled]="!tienePaginaSiguiente">Siguiente</button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading show">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
  </div>

  <!-- No data -->
  <ng-template #noData>
    <div *ngIf="!loading" class="alert alert-info">
      No hay pedidos disponibles
    </div>
  </ng-template>
</div>

<!-- ======================================== -->
<!-- MODAL DE EDICIÓN HTML COMPLETO -->
<!-- ======================================== -->
<div class="modal-overlay" *ngIf="mostrarModalEdicion" (click)="cerrarModalEdicion()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>✨ Editar Pedido #{{ pedidoIdEditar }}</h2>
      <button class="close-btn" (click)="cerrarModalEdicion()">&times;</button>
    </div>

    <div class="modal-body">
      <!-- Alertas del modal -->
      <div class="alert alert-success" *ngIf="modalSuccess">
        <span>✓</span> <span>{{ modalSuccess }}</span>
      </div>
      
      <div class="alert alert-danger" *ngIf="modalError">
        <span>⚠</span> <span>{{ modalError }}</span>
      </div>

      <form [formGroup]="pedidoForm" (ngSubmit)="onSubmitModal()" *ngIf="pedidoForm">
        <!-- Información General -->
        <div class="section">
          <h3 class="section-title">
            <span class="section-icon">👤</span>
            Información General
          </h3>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="cliente" class="required">Cliente</label>
              <select formControlName="cliente_id" class="form-input">
                <option value="">Seleccione un cliente</option>
                <option *ngFor="let cliente of clientes" [value]="cliente.id">
                  {{ cliente.nombre }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="ruta" class="required">Ruta de Entrega</label>
              <select formControlName="ruta_id" class="form-input">
                <option value="">Seleccione una ruta</option>
                <option *ngFor="let ruta of rutas" [value]="ruta.id">
                  {{ ruta.nombre_ruta }}
                </option>
              </select>
            </div>

            <div class="form-group">
              <label for="fechaEntrega" class="required">Fecha de Entrega</label>
              <input 
                type="datetime-local" 
                formControlName="fecha_entrega" 
                class="form-input"
              />
            </div>

            <div class="form-group">
              <label for="estado">Estado del Pedido</label>
              <select formControlName="estado_pedido" class="form-input">
                <option value="Pendiente">Pendiente</option>
                <option value="Confirmado">Confirmado</option>
                <option value="En_Preparacion">En Preparación</option>
                <option value="En_Transito">En Tránsito</option>
                <option value="Entregado">Entregado</option>
                <option value="Cancelado">Cancelado</option>
              </select>
            </div>

            <div class="form-group full-width">
              <label for="observaciones">Observaciones</label>
              <textarea 
                formControlName="observaciones" 
                class="form-input"
                placeholder="Notas adicionales, instrucciones especiales..."
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Productos -->
        <div class="section">
          <h3 class="section-title">
            <span class="section-icon">📦</span>
            Productos del Pedido
          </h3>
          
          <div class="productos-section">
            <div formArrayName="productos">
              <div 
                *ngFor="let producto of productosFormArray.controls; let i = index" 
                [formGroupName]="i"
                class="producto-card"
              >
                <div class="producto-header">
                  <div class="producto-numero">{{ i + 1 }}</div>
                  <button 
                    type="button" 
                    class="remove-btn"
                    (click)="removerProductoModal(i)"
                    *ngIf="productosFormArray.length > 1"
                  >
                    ×
                  </button>
                </div>
                
                <div class="form-grid">
                  <div class="form-group">
                    <label class="required">Producto</label>
                    <select 
                      formControlName="producto_id"
                      class="form-input"
                      (change)="onProductoChangeModal(i)"
                    >
                      <option value="">Seleccione un producto</option>
                      <option *ngFor="let prod of productos" [value]="prod.id">
                        {{ prod.nombre_producto }} - ${{ prod.precio_unitario | number:'1.2-2' }}
                      </option>
                    </select>
                  </div>
                  
                  <div class="form-group">
                    <label class="required">Cantidad</label>
                    <input 
                      type="number" 
                      formControlName="cantidad"
                      class="form-input"
                      min="1" 
                      (input)="calcularSubtotalModal(i)"
                    />
                  </div>
                  
                  <div class="form-group">
                    <label class="required">Precio Unitario</label>
                    <input 
                      type="number" 
                      formControlName="precio_unitario"
                      class="form-input"
                      step="0.01" 
                      min="0.01"
                      (input)="calcularSubtotalModal(i)"
                    />
                  </div>
                </div>
                
                <div class="subtotal-display">
                  <div class="subtotal-label">Subtotal</div>
                  <div class="subtotal-amount">${{ calcularSubtotalModal(i) | number:'1.2-2' }}</div>
                </div>
              </div>
            </div>
            
            <button type="button" class="add-producto-btn" (click)="agregarProductoModal()">
              <span>+</span>
              Agregar Producto
            </button>
          </div>
        </div>

        <!-- Total -->
        <div class="total-section">
          <div class="total-label">Total del Pedido</div>
          <div class="total-amount">${{ calcularTotalModal() | number:'1.2-2' }}</div>
        </div>

        <!-- Acciones -->
        <div class="form-actions">
          <button 
            type="submit" 
            class="btn btn-primary" 
            [disabled]="pedidoForm.invalid || modalLoading"
          >
            {{ modalLoading ? 'Guardando...' : 'Actualizar Pedido' }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="cerrarModalEdicion()">
            Cancelar
          </button>
        </div>
      </form>

      <!-- Loading overlay del modal -->
      <div class="loading" *ngIf="modalLoading">
        <div class="spinner"></div>
      </div>
    </div>
  </div>
</div>
